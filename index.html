<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acca Master: v10 Fixer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --safe: #4cc9f0; --risk: #f72585; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 80px; }
        h1 { color: var(--primary); margin-bottom: 5px; font-size: 1.6rem; }
        .badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: #aaa; vertical-align: middle; margin-left: 8px; }
        
        .controls { margin-bottom: 20px; }
        button#scanBtn { background: linear-gradient(135deg, var(--primary), #00cc6a); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: 800; width: 100%; font-size: 1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(0,255,136,0.3); transition: transform 0.2s; }
        button#scanBtn:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; background: #444; cursor: wait; box-shadow: none; }
        
        .acca-card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 20px; border-left: 5px solid var(--primary); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .acca-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 12px; margin-bottom: 12px; align-items: center; }
        .acca-title { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .acca-roi { font-size: 0.9rem; color: #ccc; }
        
        .leg { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; background: #252525; padding: 10px; border-radius: 8px; }
        .leg-info { display: flex; flex-direction: column; gap: 3px; }
        .leg-match { font-weight: 600; font-size: 0.95rem; }
        
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 20px; font-weight: bold; width: fit-content; }
        .tag-safe { background: rgba(76, 201, 240, 0.2); color: var(--safe); }
        .tag-value { background: rgba(0, 255, 136, 0.2); color: var(--primary); }
        .tag-form { border: 1px solid #444; color: #aaa; margin-left: 5px; }

        .odds-box { background: #111; padding: 6px 10px; border-radius: 6px; font-weight: bold; color: var(--primary); min-width: 45px; text-align: center; }

        #console { background: #000; color: #00ff88; font-family: monospace; padding: 15px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 20px; height: 140px; overflow-y: scroll; border: 1px solid #333; line-height: 1.5; }
        .log-warn { color: #f72585 !important; }
        .log-info { color: #4cc9f0 !important; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        .card-actions { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: background 0.2s; }
        .btn-copy { background: #333; color: #fff; }
        .btn-open { background: #1a5c30; color: #fff; }
        
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <h1>Acca Master <span class="badge">v10 Fixer</span></h1>
    <p style="color:#888; margin-top:0; margin-bottom:20px; font-size:0.9rem;">Min Odds: 1.4 ‚Ä¢ Direct Odds Fetching</p>

    <div id="console">System Ready.<br>Waiting to initialize...</div>

    <div class="controls">
        <button onclick="runReliableScan()" id="scanBtn">SEARCH TOP 10 LEAGUES</button>
    </div>

    <div id="results"></div>
    <div id="toast">Selections Copied!</div>

    <script>
        // --- ‚öôÔ∏è CONFIGURATION ---
        const API_KEY = '0f29a2f96e9dd4231cee515cc5ec52b0'; 
        const BASE_URL = 'https://v3.football.api-sports.io';
        
        const MIN_ACCA_ODDS = 3.5; 
        const MIN_IND_ODDS = 1.40; // UPDATED as requested
        const CURRENT_SEASON = 2025; 
        
        // Top 10 Leagues
        const LEAGUES = [39, 140, 78, 135, 61, 40, 88, 94, 144, 203]; 

        // --- üìù LOGGING ---
        function log(msg, type='normal') {
            const c = document.getElementById('console');
            const color = type === 'error' ? 'log-warn' : (type === 'info' ? 'log-info' : '');
            c.innerHTML += `<div class="${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        let teamStats = {}; 

        // --- üöÄ RELIABLE ENGINE ---
        async function runReliableScan() {
            const btn = document.getElementById('scanBtn');
            const resDiv = document.getElementById('results');
            
            btn.disabled = true;
            resDiv.innerHTML = '';
            document.getElementById('console').innerHTML = ''; 
            
            log("Starting Reliable Scan (v10)...", 'info');

            try {
                // STEP 1: Fetch Standings (For Form)
                log(`Loading Form Data...`);
                await buildKnowledgeBase();

                // STEP 2: Find Fixtures first (Since we know this endpoint works!)
                const d1 = new Date().toISOString().split('T')[0];
                const t = new Date(); t.setDate(t.getDate() + 1);
                const d2 = t.toISOString().split('T')[0];
                
                log(`Finding matches for ${d1} & ${d2}...`);
                const [games1, games2] = await Promise.all([
                    fetchFixtures(d1),
                    fetchFixtures(d2)
                ]);
                
                const allGames = [...games1, ...games2];
                log(`Found ${allGames.length} total games.`);
                
                // STEP 3: Filter for Target Leagues
                const targetGames = allGames.filter(g => LEAGUES.includes(g.league.id));
                log(`${targetGames.length} games in Big 10 Leagues.`);

                if (targetGames.length === 0) throw new Error("No big league games found today/tomorrow.");

                // STEP 4: FETCH ODDS INDIVIDUALLY (The Fix)
                log(`Fetching odds for ${targetGames.length} matches individually...`);
                const matchesWithOdds = [];
                
                // We fetch in batches to be safe, though parallel is fine for 30-50 reqs
                const oddsPromises = targetGames.map(g => fetchGameOdds(g.fixture.id));
                const oddsResults = await Promise.all(oddsPromises);
                
                // Merge Odds into Game Objects
                for(let i=0; i<targetGames.length; i++) {
                    if(oddsResults[i]) {
                        targetGames[i].odds = oddsResults[i]; // Attach odds
                        matchesWithOdds.push(targetGames[i]);
                    }
                }
                
                log(`Successfully retrieved odds for ${matchesWithOdds.length} matches.`, 'info');

                // STEP 5: Analyze
                const picks = [];
                for (const m of matchesWithOdds) {
                    const pick = analyzeMatch(m);
                    if (pick) picks.push(pick);
                }

                log(`Identified ${picks.length} Value Picks (Odds >= 1.4).`, 'info');
                
                if (picks.length < 3) throw new Error("Not enough matches met criteria.");

                // STEP 6: Build Accas
                const accas = buildSmartAccas(picks);
                log(`Generated ${accas.length} Accumulators.`);

                if (accas.length === 0) {
                    resDiv.innerHTML = "<p style='text-align:center; color:#888;'>No combinations met the 3.5+ total odds criteria.</p>";
                } else {
                    accas.slice(0, 30).forEach((acca) => renderAcca(acca, resDiv));
                }

            } catch (err) {
                log(err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // --- üì° API CALLS ---
        
        async function fetchFixtures(date) {
            // Get basic list
            try {
                const res = await fetch(`${BASE_URL}/fixtures?date=${date}&timezone=Europe/London`, {
                    headers: { "x-rapidapi-key": API_KEY }
                });
                const json = await res.json();
                return json.response || [];
            } catch (e) { return []; }
        }

        async function fetchGameOdds(fixtureId) {
            // Get odds for specific game ID (Bypasses season/league issues)
            try {
                const res = await fetch(`${BASE_URL}/odds?fixture=${fixtureId}`, {
                    headers: { "x-rapidapi-key": API_KEY }
                });
                const json = await res.json();
                return json.response[0] || null; // Return the first odds object
            } catch (e) { return null; }
        }

        async function fetchLeagueStandings(leagueId) {
            try {
                const res = await fetch(`${BASE_URL}/standings?league=${leagueId}&season=${CURRENT_SEASON}`, {
                    headers: { "x-rapidapi-key": API_KEY }
                });
                const json = await res.json();
                return json.response[0]?.league?.standings[0] || [];
            } catch (e) { return []; }
        }

        async function buildKnowledgeBase() {
            const promises = LEAGUES.map(id => fetchLeagueStandings(id));
            const results = await Promise.all(promises);
            results.forEach(leagueData => {
                if (!leagueData) return;
                leagueData.forEach(standing => { 
                    const teamId = standing.team.id;
                    teamStats[teamId] = {
                        name: standing.team.name,
                        form: standing.form, 
                        goalsFor: standing.all.goals.for / standing.all.played,
                        goalsAgainst: standing.all.goals.against / standing.all.played
                    };
                });
            });
        }

        // --- üïµÔ∏è ANALYSIS ---
        function analyzeMatch(m) {
            // Note: Structure for /odds endpoint response attached to m.odds
            if (!m.odds || !m.odds.bookmakers || !m.odds.bookmakers.length) return null;
            
            const homeId = m.teams.home.id;
            const awayId = m.teams.away.id;
            const homeStats = teamStats[homeId];
            const awayStats = teamStats[awayId];
            
            if (!homeStats || !awayStats) return null; // Strict mode

            const bookie = m.odds.bookmakers.find(b => b.id === 6) || m.odds.bookmakers[0]; // Prefer Bet365, else take first
            const bets = bookie.bets;
            
            const getOdd = (id, val) => {
                const mk = bets.find(b => b.id === id);
                if (!mk) return null;
                const v = mk.values.find(v => v.value.toString() === val);
                return v ? parseFloat(v.odd) : null;
            };

            const candidates = [];

            // 1. HOME WIN (Form Check)
            const homeWin = getOdd(1, "Home");
            if (homeWin && homeWin >= MIN_IND_ODDS && homeWin <= 2.3) {
                const homeLosses = (homeStats.form.match(/L/g) || []).length;
                if (homeLosses <= 2) {
                    candidates.push({ 
                        sel: `${homeStats.name} Win`, 
                        odd: homeWin, 
                        type: 'Banker',
                        reason: `Form: ${homeStats.form}`
                    });
                }
            }
            
            // 2. AWAY WIN
             const awayWin = getOdd(1, "Away");
             if (awayWin && awayWin >= MIN_IND_ODDS && awayWin <= 2.3) {
                const awayLosses = (awayStats.form.match(/L/g) || []).length;
                if (awayLosses <= 2) {
                    candidates.push({ 
                        sel: `${awayStats.name} Win`, 
                        odd: awayWin, 
                        type: 'Banker',
                        reason: `Form: ${awayStats.form}`
                    });
                }
            }

            // 3. OVER 2.5 GOALS
            const combinedAvgGoals = (homeStats.goalsFor + homeStats.goalsAgainst + awayStats.goalsFor + awayStats.goalsAgainst) / 2;
            if (combinedAvgGoals > 2.8) {
                const over25 = getOdd(5, "Over 2.5");
                if (over25 && over25 >= 1.45 && over25 <= 2.0) {
                    candidates.push({ sel: "Over 2.5 Goals", odd: over25, type: 'Value', reason: "High Goals Avg" });
                }
            }
            
            // 4. DOUBLE CHANCE (Safety)
            const dcHome = getOdd(12, "Home/Draw");
            if (dcHome && dcHome >= 1.3 && dcHome <= 1.6) {
                 candidates.push({ sel: `${homeStats.name} (DC)`, odd: dcHome, type: 'Anchor', reason: "Safety Net" });
            }

            if (candidates.length === 0) return null;
            candidates.sort((a,b) => a.odd - b.odd); 
            
            const best = candidates[0];
            return {
                match: `${homeStats.name} v ${awayStats.name}`,
                sel: best.sel,
                odd: best.odd,
                type: best.type,
                form: best.reason
            };
        }

        // --- üèóÔ∏è BUILDER ---
        function buildSmartAccas(picks) {
            const results = [];
            const pool = picks.slice(0, 40); // Larger pool
            
            function combine(start, combo, k) {
                if (combo.length === k) {
                    const total = combo.reduce((a, b) => a * b.odd, 1);
                    if (total >= MIN_ACCA_ODDS) {
                        results.push({ matches: combo, odds: total });
                    }
                    return;
                }
                for(let i=start; i<pool.length; i++) {
                    if (combo.some(c => c.match === pool[i].match)) continue;
                    combine(i+1, [...combo, pool[i]], k);
                }
            }
            
            combine(0, [], 4); // 4-folds
            return results.sort((a,b) => a.odds - b.odds); 
        }

        function renderAcca(acca, div) {
            const el = document.createElement('div');
            el.className = 'acca-card';
            
            const legs = acca.matches.map(m => {
                let badgeClass = m.type === 'Anchor' ? 'tag-safe' : 'tag-value';
                return `
                <div class="leg">
                    <div class="leg-info">
                        <span class="leg-match">${m.match}</span>
                        <div style="display:flex; align-items:center;">
                            <span class="tag ${badgeClass}">${m.sel}</span>
                            <span class="tag tag-form">${m.form}</span>
                        </div>
                    </div>
                    <div class="odds-box">${m.odd.toFixed(2)}</div>
                </div>
            `}).join('');
            
            const copyText = acca.matches.map(m => `${m.match} - ${m.sel}`).join(', ');
            const returnVal = (acca.odds * 10).toFixed(2);

            el.innerHTML = `
                <div class="acca-header">
                    <div>
                        <div class="acca-title">4-Fold Strategy</div>
                        <span class="acca-roi">Est. Return: ¬£${returnVal}</span>
                    </div>
                    <div style="font-size:1.4rem; font-weight:800; color:#fff;">${acca.odds.toFixed(2)}</div>
                </div>
                ${legs}
                <div class="card-actions">
                    <button class="action-btn btn-copy" onclick="copyToClipboard('${copyText}')">üìã Copy</button>
                    <button class="action-btn btn-open" onclick="window.open('https://www.bet365.com', '_blank')">‚ÜóÔ∏è Bet365</button>
                </div>
            `;
            div.appendChild(el);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const t = document.getElementById("toast");
                t.className = "show";
                setTimeout(() => t.className = t.className.replace("show", ""), 3000);
            });
        }
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').then(reg => {
                reg.onupdatefound = () => {
                    const iw = reg.installing;
                    iw.onstatechange = () => {
                        if (iw.state === 'installed' && navigator.serviceWorker.controller) {
                            window.location.reload();
                        }
                    };
                };
            });
        }
    </script>
</body>
</html>
