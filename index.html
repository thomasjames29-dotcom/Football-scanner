<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acca Master Pro: Live</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px; }
        h1 { font-size: 1.5rem; margin-bottom: 5px; color: var(--primary); }
        h2 { font-size: 1rem; color: #888; margin-top: 0; font-weight: normal; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* Controls */
        .controls { margin-bottom: 20px; display: flex; gap: 10px; margin-top: 15px; }
        button { background: var(--primary); color: #000; border: none; padding: 14px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; text-transform: uppercase; font-size: 1rem;}
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #555; color: #888; }
        
        /* Cards */
        .acca-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .acca-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .acca-odds { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .acca-return { font-size: 0.9rem; color: #aaa; }
        
        .leg { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center;}
        .leg-match { color: #fff; display: flex; flex-direction: column; }
        .leg-league { font-size: 0.7rem; color: #888; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
        .leg-bet { color: #ccc; font-size: 0.85rem; text-align: right; min-width: 80px; background: #2a2a2a; padding: 4px 8px; border-radius: 4px;}
        
        .status-box { text-align: center; color: #888; margin-top: 50px; display: none; line-height: 1.6; font-size: 0.9rem; }
        .install-btn { display: none; background: #333; color: #fff; margin-bottom: 20px; }
        .error-msg { color: #ff5555; background: #331111; padding: 15px; border-radius: 8px; text-align: center; margin-top: 20px; font-size: 0.9rem; border: 1px solid #ff4444;}
    </style>
</head>
<body>

    <button id="installBtn" class="install-btn">ðŸ“² Install App</button>

    <h1>Acca Master Pro</h1>
    <h2>LIVE DATA â€¢ Next 24h</h2>

    <div class="controls">
        <button onclick="runAnalysis()" id="genBtn">Generate Accas</button>
    </div>

    <div id="loading" class="status-box">
        Initializing...
    </div>

    <div id="results"></div>

    <script>
        // --- 1. CONFIGURATION ---
        const API_KEY = '0f29a2f96e9dd4231cee515cc5ec52b0'; 
        const MIN_ACCUMULATOR_ODDS = 5.0; // 4/1
        
        // IDs: World Cup(1), UCL(2), UEL(3), EPL(39), La Liga(140), Bundesliga(78), Serie A(135), Ligue 1(61), Eredivisie(88), Primeira Liga(94), Championship(40)
        const TARGET_LEAGUES = [1, 2, 3, 39, 140, 78, 135, 61, 88, 94, 40]; 

        // --- 2. PWA INSTALL LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installBtn');
            btn.style.display = 'block';
            btn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') btn.style.display = 'none';
                    deferredPrompt = null;
                });
            });
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js');
        }

        // --- 3. CORE LOGIC ---

        async function runAnalysis() {
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const btn = document.getElementById('genBtn');
            
            resultsDiv.innerHTML = '';
            loadingDiv.style.display = 'block';
            loadingDiv.innerHTML = "Connecting to API...<br>Fetching latest fixtures...";
            btn.disabled = true;

            try {
                // Get today and tomorrow dates
                const today = new Date().toISOString().split('T')[0];
                const tomorrowDate = new Date();
                tomorrowDate.setDate(tomorrowDate.getDate() + 1);
                const tomorrow = tomorrowDate.toISOString().split('T')[0];

                // Fetch both days in parallel
                const [dataToday, dataTomorrow] = await Promise.all([
                    fetchFixturesByDate(today),
                    fetchFixturesByDate(tomorrow)
                ]);

                loadingDiv.innerHTML = `Scanning ${dataToday.length + dataTomorrow.length} matches...<br>Filtering for Major Leagues...`;

                // Merge and Filter
                let allMatches = [...dataToday, ...dataTomorrow];
                
                // FILTER: Only Target Leagues AND Within 24 Hours
                const validMatches = allMatches.filter(m => {
                    return isBigLeague(m) && isWithin24Hours(m.fixture.date);
                });

                if (validMatches.length < 3) {
                    throw new Error(`Only found ${validMatches.length} matches in the supported leagues in the next 24h. Not enough for an acca.`);
                }

                loadingDiv.innerHTML = `Found ${validMatches.length} valid matches.<br>Analyzing odds & form...`;

                // Analyze Form/Odds
                const picks = validMatches
                    .map(m => analyzeMatch(m))
                    .filter(p => p !== null);

                if (picks.length < 3) {
                     throw new Error(`Found matches, but the odds were too low/high to be considered "Value". Try again on a busy matchday.`);
                }

                // Generate Accas
                loadingDiv.innerHTML = `Building Combinations...`;
                
                // We mix picks to try and get variety
                const accas = [
                    ...generateCombinations(picks, 3),
                    ...generateCombinations(picks, 4)
                ];

                // Render Results
                loadingDiv.style.display = 'none';
                btn.disabled = false;

                if(accas.length === 0) {
                    resultsDiv.innerHTML = '<div class="error-msg">No combinations met the 4/1 odds requirement.</div>';
                    return;
                }

                // Sort by highest odds
                accas.sort((a, b) => b.totalOdds - a.totalOdds);
                
                resultsDiv.innerHTML = `<p style="text-align:center; color:#666; font-size:0.8rem">Generated from ${picks.length} value picks across Europe</p>`;
                
                // Display top 25
                accas.slice(0, 25).forEach(acca => renderAccaCard(acca, resultsDiv));

            } catch (error) {
                console.error(error);
                loadingDiv.style.display = 'none';
                btn.disabled = false;
                resultsDiv.innerHTML = `<div class="error-msg"><strong>Error:</strong> ${error.message}</div>`;
            }
        }

        // --- 4. DATA FETCHING ---

        async function fetchFixturesByDate(dateStr) {
            // Using Europe/London timezone for consistency
            const url = `https://v3.football.api-sports.io/fixtures?date=${dateStr}&timezone=Europe/London`;
            const response = await fetch(url, {
                "method": "GET",
                "headers": {
                    "x-rapidapi-host": "v3.football.api-sports.io",
                    "x-rapidapi-key": API_KEY
                }
            });
            
            if (!response.ok) throw new Error("API Error: " + response.statusText);
            const data = await response.json();
            
            if (data.errors && Object.keys(data.errors).length > 0) {
                throw new Error("API Provider Error: " + JSON.stringify(data.errors));
            }

            return data.response || [];
        }

        // --- 5. ANALYSIS LOGIC ---

        function isBigLeague(match) {
            return TARGET_LEAGUES.includes(match.league.id);
        }

        function isWithin24Hours(dateString) {
            const matchTime = new Date(dateString).getTime();
            const now = new Date().getTime();
            const timeDiff = matchTime - now;
            // Must be in future (positive) and less than 24h
            return timeDiff > 0 && timeDiff < (24 * 60 * 60 * 1000);
        }

        function analyzeMatch(match) {
            const bookmakers = match.odds?.bookmakers || [];
            if (!bookmakers.length) return null;
            
            const market = bookmakers[0].bets.find(b => b.id === 1); // Match Winner
            if (!market) return null;

            const homeVal = market.values.find(v => v.value === 'Home');
            const awayVal = market.values.find(v => v.value === 'Away');

            if (!homeVal) return null;

            const homeOdd = parseFloat(homeVal.odd);
            
            // LOGIC: Back Home Favorites
            // Range: 1.40 - 2.20
            if (homeOdd >= 1.4 && homeOdd <= 2.20) {
                 return {
                    id: match.fixture.id,
                    home: match.teams.home.name,
                    away: match.teams.away.name,
                    league: match.league.name,
                    prediction: "Home Win",
                    selectedOdds: homeOdd,
                    timestamp: match.fixture.date
                };
            }
            return null;
        }

        // --- 6. COMBINATORICS (With Variety Check) ---

        function generateCombinations(arr, k) {
            const results = [];
            // Sort by odds to get best value first, limit to top 25 candidates for performance
            const pool = arr.sort((a,b) => b.selectedOdds - a.selectedOdds).slice(0, 25);

            function combine(start, combo) {
                if (combo.length === k) {
                    const totalOdds = combo.reduce((acc, match) => acc * match.selectedOdds, 1);
                    
                    // VARIETY CHECK: If it's a 4-fold, try to ensure not ALL are from same league
                    // (Optional: remove this 'if' block if you don't care about variety)
                    const uniqueLeagues = new Set(combo.map(c => c.league));
                    const varietyScore = uniqueLeagues.size; // How many diff leagues?
                    
                    // Rule: Accept if odds are good. 
                    // Ideally we want varietyScore > 1, but if only EPL is playing, we must accept 1.
                    
                    if (totalOdds >= MIN_ACCUMULATOR_ODDS) {
                        results.push({
                            matches: combo,
                            totalOdds: totalOdds.toFixed(2),
                            returnOn10: (totalOdds * 10).toFixed(2),
                            variety: varietyScore // We can use this to sort later
                        });
                    }
                    return;
                }
                for (let i = start; i < pool.length; i++) {
                    combine(i + 1, [...combo, pool[i]]);
                }
            }
            combine(0, []);
            return results;
        }

        // --- 7. RENDERING ---

        function renderAccaCard(acca, container) {
            const card = document.createElement('div');
            card.className = 'acca-card';
            
            let legsHtml = acca.matches.map(m => {
                const dateObj = new Date(m.timestamp);
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `
                <div class="leg">
                    <div class="leg-match">
                        <span class="leg-league">${m.league} â€¢ ${timeStr}</span>
                        <span>${m.home} v ${m.away}</span>
                    </div>
                    <span class="leg-bet">${m.prediction}<br>@ ${m.selectedOdds}</span>
                </div>
            `}).join('');

            card.innerHTML = `
                <div class="acca-header">
                    <span class="acca-odds">${acca.matches.length}-Fold @ ${acca.totalOdds}</span>
                    <span class="acca-return">Returns Â£${acca.returnOn10}</span>
                </div>
                ${legsHtml}
            `;
            container.appendChild(card);
        }
    </script>
</body>
</html>
