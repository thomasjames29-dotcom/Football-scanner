<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acca Master: Live V3</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 80px; }
        h1 { color: var(--primary); margin-bottom: 5px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        button { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 1rem; cursor: pointer; }
        button:disabled { opacity: 0.5; background: #555; }
        
        .acca-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
        .acca-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: var(--primary); }
        .leg { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center; }
        .leg-meta { font-size: 0.75rem; color: #888; display: block; }
        
        #console { background: #000; color: #0f0; font-family: monospace; padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 20px; height: 100px; overflow-y: scroll; border: 1px solid #333; }
        .error { color: #ff5555; }
    </style>
</head>
<body>

    <h1>Acca Master Pro</h1>
    <p style="color:#888; margin-top:0;">Live Data â€¢ 3/1+ Odds</p>

    <div id="console">System Ready. Waiting for user...</div>

    <div class="controls">
        <button onclick="startScan()" id="btn">SEARCH LIVE MARKETS</button>
    </div>

    <div id="results"></div>

    <script>
        // --- API CONFIG ---
        const API_KEY = '0f29a2f96e9dd4231cee515cc5ec52b0';
        const BASE_URL = 'https://v3.football.api-sports.io';
        
        // --- SETTINGS ---
        // CHANGED: Minimum odds now 4.0 (3/1)
        const MIN_ACCUMULATOR_ODDS = 4.0; 
        
        // --- LEAGUE CONFIG (Major Leagues Only) ---
        // 39=PL, 140=LaLiga, 135=SerieA, 78=Bundesliga, 61=Ligue1
        const TARGET_LEAGUES = [39, 140, 135, 78, 61]; 

        function log(msg, type='info') {
            const c = document.getElementById('console');
            const color = type === 'error' ? '#ff5555' : '#00ff88';
            c.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        async function startScan() {
            const btn = document.getElementById('btn');
            const resDiv = document.getElementById('results');
            
            btn.disabled = true;
            resDiv.innerHTML = '';
            document.getElementById('console').innerHTML = ''; // Clear console
            
            log("Starting Scan...");

            try {
                // 1. Get Dates
                const today = new Date().toISOString().split('T')[0];
                log(`Fetching fixtures for: ${today}`);

                // 2. Fetch Data
                const data = await fetchFromApi(today);
                log(`API returned ${data.length} total matches.`);

                // 3. Filter
                const validMatches = data.filter(m => {
                    const isTargetLeague = TARGET_LEAGUES.includes(m.league.id);
                    const isFuture = ['NS'].includes(m.fixture.status.short);
                    return isTargetLeague && isFuture;
                });

                log(`Found ${validMatches.length} matches in Target Leagues (Not Started).`);

                if (validMatches.length === 0) {
                    throw new Error("No matches found in big 5 leagues today.");
                }

                // 4. Analyze Odds
                const picks = [];
                for (const m of validMatches) {
                    const pick = analyzeMatch(m);
                    if (pick) picks.push(pick);
                }

                log(`Identified ${picks.length} value selections.`);

                if (picks.length < 3) {
                    throw new Error("Not enough matches met the odds criteria for an acca.");
                }

                // 5. Generate Accas
                const accas = generateAccas(picks);
                log(`Generated ${accas.length} Accumulators.`);

                if (accas.length === 0) {
                    resDiv.innerHTML = "<p>No accas found over 3/1 odds.</p>";
                } else {
                    accas.slice(0, 20).forEach(acca => renderAcca(acca, resDiv));
                }

            } catch (err) {
                log(err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function fetchFromApi(date) {
            const response = await fetch(`${BASE_URL}/fixtures?date=${date}&timezone=Europe/London`, {
                method: "GET",
                headers: {
                    "x-rapidapi-host": "v3.football.api-sports.io",
                    "x-rapidapi-key": API_KEY
                }
            });
            const json = await response.json();
            
            if (json.errors && Object.keys(json.errors).length > 0) {
                throw new Error("API Limit/Key Error: " + JSON.stringify(json.errors));
            }
            return json.response;
        }

        function analyzeMatch(m) {
            // Safety check for odds structure
            if(!m.odds || !m.odds.bookmakers) return null;
            const b = m.odds.bookmakers[0];
            if(!b) return null;
            const bet = b.bets.find(x => x.name === 'Match Winner');
            if(!bet) return null;
            
            const home = bet.values.find(v => v.value === 'Home');
            if(!home) return null;
            
            const odd = parseFloat(home.odd);
            
            // Strategy: Back Home Favorites
            // Range: 1.40 - 2.20
            if (odd >= 1.4 && odd <= 2.2) {
                return {
                    home: m.teams.home.name,
                    away: m.teams.away.name,
                    odd: odd,
                    league: m.league.name,
                    time: m.fixture.date
                };
            }
            return null;
        }

        function generateAccas(picks) {
            const results = [];
            
            if (picks.length < 3) return [];
            
            const pool = picks.slice(0, 15);
            
            // Generate 3-folds and 4-folds
            function combine(start, combo, targetSize) {
                if (combo.length === targetSize) {
                    const total = combo.reduce((a, b) => a * b.odd, 1);
                    if (total > MIN_ACCUMULATOR_ODDS) { // Now checking against 4.0 (3/1)
                        results.push({ matches: combo, odds: total });
                    }
                    return;
                }
                for(let i=start; i<pool.length; i++) {
                    combine(i+1, [...combo, pool[i]], targetSize);
                }
            }

            // Run for 3-folds
            combine(0, [], 3);
            // Run for 4-folds
            combine(0, [], 4);

            return results.sort((a,b) => b.odds - a.odds);
        }

        function renderAcca(acca, div) {
            const el = document.createElement('div');
            el.className = 'acca-card';
            const html = acca.matches.map(m => `
                <div class="leg">
                    <div>
                        <span class="leg-meta">${m.league}</span>
                        ${m.home} vs ${m.away}
                    </div>
                    <strong>${m.odd}</strong>
                </div>
            `).join('');
            
            el.innerHTML = `
                <div class="acca-header">
                    <span>${acca.matches.length}-Fold</span>
                    <span>${acca.odds.toFixed(2)} (${Math.floor(acca.odds)-1}/1)</span>
                </div>
                ${html}
            `;
            div.appendChild(el);
        }

        // SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    window.location.reload();
                                }
                            }
                        };
                    };
                });
        }
    </script>
</body>
</html>
