<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acca Master: Unlimited</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 80px; }
        h1 { color: var(--primary); margin-bottom: 5px; }
        
        .controls { margin-bottom: 20px; }
        button#scanBtn { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 1rem; cursor: pointer; }
        button:disabled { opacity: 0.5; background: #555; }
        
        .acca-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary); position: relative; }
        .acca-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: var(--primary); align-items: center;}
        
        .card-actions { display: flex; gap: 8px; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
        .action-btn { flex: 1; padding: 8px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        .btn-copy { background: #333; color: #fff; }
        .btn-open { background: #1a5c30; color: #fff; }

        .leg { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center; }
        .leg-info { display: flex; flex-direction: column; }
        .leg-meta { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
        .leg-market { color: #00ff88; font-size: 0.8rem; background: #004422; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; width: fit-content;}
        
        #console { background: #000; color: #0f0; font-family: monospace; padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 20px; height: 120px; overflow-y: scroll; border: 1px solid #333; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <h1>Acca Master Pro</h1>
    <p style="color:#888; margin-top:0;">UNLIMITED MODE ‚Ä¢ 10 Leagues</p>

    <div id="console">System Ready. High-Volume API Mode Active.</div>

    <div class="controls">
        <button onclick="runUnlimitedScan()" id="scanBtn">SEARCH TOP 10 LEAGUES</button>
    </div>

    <div id="results"></div>
    <div id="toast">Selections Copied!</div>

    <script>
        // --- ‚öôÔ∏è CONFIGURATION ---
        const API_KEY = '0f29a2f96e9dd4231cee515cc5ec52b0';
        const BASE_URL = 'https://v3.football.api-sports.io';
        
        const MIN_ACCA_ODDS = 4.0; // 3/1
        const MIN_IND_ODDS = 1.20; 
        const MAX_IND_ODDS = 4.00; 
        
        // EXPANDED LEAGUE LIST (Top 10)
        // EPL(39), LaLiga(140), Bundesliga(78), SerieA(135), Ligue1(61)
        // Championship(40), Eredivisie(88), Primeira(94), Belgium(144), Turkey(203)
        const TARGET_LEAGUES = [39, 140, 78, 135, 61, 40, 88, 94, 144, 203]; 
        
        const CURRENT_SEASON = 2025; 

        // --- üìù LOGGING SYSTEM ---
        function log(msg, type='info') {
            const c = document.getElementById('console');
            const color = type === 'error' ? '#ff5555' : (type === 'warn' ? '#ffaa00' : '#00ff88');
            c.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        // --- üöÄ MAIN ENGINE ---
        async function runUnlimitedScan() {
            const btn = document.getElementById('scanBtn');
            const resDiv = document.getElementById('results');
            
            btn.disabled = true;
            resDiv.innerHTML = '';
            document.getElementById('console').innerHTML = ''; 
            
            log("Starting High-Volume Scan...");

            try {
                // We scan Today and Tomorrow
                const d1 = new Date().toISOString().split('T')[0];
                const t = new Date(); t.setDate(t.getDate() + 1);
                const d2 = t.toISOString().split('T')[0];
                
                log(`Target Dates: ${d1}, ${d2}`);
                log(`Scanning ${TARGET_LEAGUES.length} Leagues in Parallel...`);

                let allMatches = [];

                // Create a massive list of promises to fire at once
                const promises = [];
                for (let leagueId of TARGET_LEAGUES) {
                    promises.push(fetchLeagueOdds(leagueId, d1));
                    promises.push(fetchLeagueOdds(leagueId, d2));
                }

                // Fire all requests
                const results = await Promise.all(promises);

                // Flatten results
                results.forEach(r => {
                    if(r && r.length > 0) allMatches = [...allMatches, ...r];
                });

                log(`Total Matches with Odds: ${allMatches.length}`);

                if (allMatches.length === 0) {
                    throw new Error("No odds found. Check season year or API status.");
                }

                // 2. Find Value Bets
                const picks = [];
                for (const m of allMatches) {
                    const pick = findBestValue(m);
                    if (pick) picks.push(pick);
                }

                log(`Found ${picks.length} valid selections.`);

                if (picks.length < 3) throw new Error("Not enough selections to build an acca.");

                // 3. Generate Combinations
                const accas = generateAccas(picks);
                log(`Built ${accas.length} Accumulators.`);

                if (accas.length === 0) {
                    resDiv.innerHTML = "<p style='text-align:center'>Matches found, but no combinations reached 3/1 odds.</p>";
                } else {
                    accas.slice(0, 30).forEach((acca, i) => renderAcca(acca, resDiv));
                }

            } catch (err) {
                log(err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // --- üì° API FETCHER ---
        async function fetchLeagueOdds(leagueId, date) {
            const url = `${BASE_URL}/odds?league=${leagueId}&season=${CURRENT_SEASON}&date=${date}&bookmaker=6`;
            try {
                const response = await fetch(url, {
                    method: "GET",
                    headers: { "x-rapidapi-host": "v3.football.api-sports.io", "x-rapidapi-key": API_KEY }
                });
                const json = await response.json();
                return json.response || [];
            } catch (e) {
                return [];
            }
        }

        // --- üß† ODDS ANALYZER ---
        function findBestValue(m) {
            if (!m.bookmakers || !m.bookmakers[0]) return null;
            const bets = m.bookmakers[0].bets;

            const candidates = [];
            const homeTeam = m.teams?.home?.name || m.fixture.home.name || "Home"; 
            const awayTeam = m.teams?.away?.name || m.fixture.away.name || "Away";

            const getOdd = (id, val) => {
                const market = bets.find(b => b.id === id);
                if (!market) return null;
                const selection = market.values.find(v => v.value.toString() === val);
                return selection ? parseFloat(selection.odd) : null;
            };

            // 1. MATCH WINNER (ID 1)
            const homeWin = getOdd(1, "Home");
            const awayWin = getOdd(1, "Away");
            
            if (homeWin >= MIN_IND_ODDS && homeWin <= MAX_IND_ODDS) 
                candidates.push({ sel: `${homeTeam} Win`, odd: homeWin, type: "Result" });
            
            if (awayWin >= MIN_IND_ODDS && awayWin <= MAX_IND_ODDS) 
                candidates.push({ sel: `${awayTeam} Win`, odd: awayWin, type: "Result" });

            // 2. BTTS (ID 8)
            const bttsYes = getOdd(8, "Yes");
            if (bttsYes >= 1.5 && bttsYes <= 2.1)
                candidates.push({ sel: "BTTS: Yes", odd: bttsYes, type: "Goals" });

            // 3. OVER 2.5 (ID 5)
            const over25 = getOdd(5, "Over 2.5");
            if (over25 >= 1.4 && over25 <= 2.0)
                candidates.push({ sel: "Over 2.5 Goals", odd: over25, type: "Goals" });

            // 4. DOUBLE CHANCE (ID 12)
            const dcHome = getOdd(12, "Home/Draw");
            if (dcHome >= 1.25 && dcHome <= 1.8)
                candidates.push({ sel: `${homeTeam} or Draw`, odd: dcHome, type: "Safety" });

            if (candidates.length === 0) return null;

            candidates.sort((a, b) => a.odd - b.odd);

            return {
                match: `${homeTeam} vs ${awayTeam}`,
                selection: candidates[0].sel,
                odd: candidates[0].odd,
                market: candidates[0].type
            };
        }

        // --- üîó COMBINATORICS ---
        function generateAccas(picks) {
            const results = [];
            if (picks.length < 3) return [];
            
            // Increased pool size for Unlimited Mode
            const pool = picks.slice(0, 30); 
            
            function combine(start, combo, k) {
                if (combo.length === k) {
                    const total = combo.reduce((a, b) => a * b.odd, 1);
                    if (total >= MIN_ACCA_ODDS) {
                        results.push({ matches: combo, odds: total });
                    }
                    return;
                }
                for(let i=start; i<pool.length; i++) {
                    if (combo.some(c => c.match === pool[i].match)) continue;
                    combine(i+1, [...combo, pool[i]], k);
                }
            }

            combine(0, [], 4);
            // Also try 5-folds if pool is large
            if (picks.length > 10) combine(0, [], 5);
            
            return results.sort((a,b) => b.odds - a.odds);
        }

        // --- üé® RENDERING ---
        function renderAcca(acca, div) {
            const el = document.createElement('div');
            el.className = 'acca-card';
            
            const legs = acca.matches.map(m => `
                <div class="leg">
                    <div class="leg-info">
                        <span class="leg-meta">${m.match}</span>
                        <span class="leg-market">${m.selection}</span>
                    </div>
                    <strong>${m.odd.toFixed(2)}</strong>
                </div>
            `).join('');
            
            const copyText = acca.matches.map(m => `${m.match} (${m.selection})`).join(', ');

            el.innerHTML = `
                <div class="acca-header">
                    <span>${acca.matches.length}-Fold</span>
                    <span>${acca.odds.toFixed(2)} (${Math.floor(acca.odds)-1}/1)</span>
                </div>
                ${legs}
                <div class="card-actions">
                    <button class="action-btn btn-copy" onclick="copyToClipboard('${copyText}')">üìã Copy</button>
                    <button class="action-btn btn-open" onclick="window.open('https://www.bet365.com', '_blank')">‚ÜóÔ∏è Bet365</button>
                </div>
            `;
            div.appendChild(el);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const t = document.getElementById("toast");
                t.className = "show";
                setTimeout(() => t.className = t.className.replace("show", ""), 3000);
            });
        }
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').then(reg => {
                reg.onupdatefound = () => {
                    const iw = reg.installing;
                    iw.onstatechange = () => {
                        if (iw.state === 'installed' && navigator.serviceWorker.controller) {
                            window.location.reload();
                        }
                    };
                };
            });
        }
    </script>
</body>
</html>
