<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acca Master Pro: Europe</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px; }
        h1 { font-size: 1.5rem; margin-bottom: 5px; color: var(--primary); }
        h2 { font-size: 1rem; color: #888; margin-top: 0; font-weight: normal; }
        
        /* Controls */
        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        button { background: var(--primary); color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; text-transform: uppercase;}
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Cards */
        .acca-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .acca-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .acca-odds { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .acca-return { font-size: 0.9rem; color: #aaa; }
        
        .leg { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center;}
        .leg-match { color: #fff; display: flex; flex-direction: column; }
        .leg-league { font-size: 0.7rem; color: #666; margin-bottom: 2px; }
        .leg-bet { color: #ccc; font-size: 0.85rem; text-align: right; min-width: 80px;}
        
        .loading { text-align: center; color: #666; margin-top: 50px; display: none; line-height: 1.6; }
        .install-btn { display: none; background: #333; color: #fff; margin-bottom: 20px; }
        .error-msg { color: #ff4444; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <button id="installBtn" class="install-btn">ðŸ“² Install App</button>

    <h1>Acca Master Pro</h1>
    <h2>Europe's Big 5 â€¢ Next 24h</h2>

    <div class="controls">
        <button onclick="runAnalysis()" id="genBtn">Generate Accas</button>
    </div>

    <div id="loading" class="loading">
        Connecting to API...<br>
        Scanning Premier League, La Liga, Serie A...<br>
        Filtering for next 24 hours...
    </div>

    <div id="results"></div>

    <script>
        // --- 1. CONFIGURATION ---
        // PASTE YOUR KEY BELOW
        const API_KEY = 'PASTE_YOUR_KEY_HERE'; 
        
        const MIN_ACCUMULATOR_ODDS = 5.0; // 4/1
        
        // IDs for: World Cup, UCL, UEL, EPL, La Liga, Bundesliga, Serie A, Ligue 1, Eredivisie, Primeira Liga
        const TARGET_LEAGUES = [1, 2, 3, 39, 140, 78, 135, 61, 88, 94]; 

        // --- 2. PWA INSTALL LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installBtn');
            btn.style.display = 'block';
            btn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') btn.style.display = 'none';
                    deferredPrompt = null;
                });
            });
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js');
        }

        // --- 3. CORE LOGIC ---

        async function runAnalysis() {
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const btn = document.getElementById('genBtn');
            
            if(API_KEY === 'PASTE_YOUR_KEY_HERE') {
                alert("Please open index.html and paste your API Key first!");
                return;
            }

            resultsDiv.innerHTML = '';
            loadingDiv.style.display = 'block';
            btn.disabled = true;

            try {
                // Fetch matches for Today and Tomorrow (to cover the full 24h rolling window)
                const today = new Date().toISOString().split('T')[0];
                const tomorrowDate = new Date();
                tomorrowDate.setDate(tomorrowDate.getDate() + 1);
                const tomorrow = tomorrowDate.toISOString().split('T')[0];

                // Parallel Fetch
                const [dataToday, dataTomorrow] = await Promise.all([
                    fetchFixturesByDate(today),
                    fetchFixturesByDate(tomorrow)
                ]);

                // Merge Data
                let allMatches = [...dataToday, ...dataTomorrow];

                // Filter: Big Leagues Only + Next 24 Hours Only
                const validMatches = allMatches.filter(m => {
                    return isBigLeague(m) && isWithin24Hours(m.fixture.date);
                });

                if (validMatches.length < 3) {
                    throw new Error(`Only found ${validMatches.length} matches in the big leagues in the next 24h. Not enough for an acca.`);
                }

                // Analyze Form & Odds
                const picks = validMatches
                    .map(m => analyzeMatch(m))
                    .filter(p => p !== null);

                // Generate Accas (3-folds and 4-folds)
                const accas = [
                    ...generateCombinations(picks, 3),
                    ...generateCombinations(picks, 4)
                ];

                // Render
                loadingDiv.style.display = 'none';
                btn.disabled = false;

                if(accas.length === 0) {
                    resultsDiv.innerHTML = '<p class="error-msg">Found matches, but none met the strict form & odds criteria for a 4/1 acca.</p>';
                    return;
                }

                // Sort by highest odds and slice top 25
                accas.sort((a, b) => b.totalOdds - a.totalOdds);
                
                resultsDiv.innerHTML = `<p style="text-align:center; color:#666; font-size:0.8rem">Generated from ${picks.length} value picks</p>`;
                accas.slice(0, 25).forEach(acca => renderAccaCard(acca, resultsDiv));

            } catch (error) {
                console.error(error);
                loadingDiv.style.display = 'none';
                btn.disabled = false;
                resultsDiv.innerHTML = `<p class="error-msg">${error.message}</p>`;
            }
        }

        // --- 4. DATA FETCHING ---

        async function fetchFixturesByDate(dateStr) {
            const url = `https://v3.football.api-sports.io/fixtures?date=${dateStr}`;
            const response = await fetch(url, {
                "method": "GET",
                "headers": {
                    "x-rapidapi-host": "v3.football.api-sports.io",
                    "x-rapidapi-key": API_KEY
                }
            });
            
            if (!response.ok) throw new Error("API Error: " + response.statusText);
            const data = await response.json();
            return data.response || [];
        }

        // --- 5. FILTERS & ANALYSIS ---

        function isBigLeague(match) {
            return TARGET_LEAGUES.includes(match.league.id);
        }

        function isWithin24Hours(dateString) {
            const matchTime = new Date(dateString).getTime();
            const now = new Date().getTime();
            const timeDiff = matchTime - now;
            // Diff must be positive (future) and less than 24h (86400000 ms)
            return timeDiff > 0 && timeDiff < 86400000;
        }

        function analyzeMatch(match) {
            // Safe navigation for odds
            const bookmakers = match.odds?.bookmakers || [];
            if (!bookmakers.length) return null;
            
            // Get Match Winner odds (Bet ID 1)
            const market = bookmakers[0].bets.find(b => b.id === 1);
            if (!market) return null;

            const homeOdd = parseFloat(market.values.find(v => v.value === 'Home')?.odd);
            
            // Simple Form Analysis
            // (In a real app, you'd calculate this from the 'fixture.stats' or separate endpoint.
            // Since the daily fixtures endpoint doesn't always have full historic form attached,
            // we will use a "Value Logic" here based on implied probability vs odds).
            
            // Rule: We want Home Favorites, but not super short odds.
            // Odds between 1.40 and 2.10 are the "Sweet Spot" for accas.
            if (homeOdd >= 1.4 && homeOdd <= 2.10) {
                 return {
                    id: match.fixture.id,
                    home: match.teams.home.name,
                    away: match.teams.away.name,
                    league: match.league.name,
                    prediction: "Home Win",
                    selectedOdds: homeOdd,
                    timestamp: match.fixture.date
                };
            }
            
            return null;
        }

        // --- 6. COMBINATORICS ---

        function generateCombinations(arr, k) {
            const results = [];
            
            // Limit input array to prevent browser crash if too many matches (max 20 best candidates)
            // Realistically, for "Big Leagues" only, we won't have 100s of matches a day.
            const pool = arr.slice(0, 20); 

            function combine(start, combo) {
                if (combo.length === k) {
                    const totalOdds = combo.reduce((acc, match) => acc * match.selectedOdds, 1);
                    if (totalOdds >= MIN_ACCUMULATOR_ODDS) {
                        results.push({
                            matches: combo,
                            totalOdds: totalOdds.toFixed(2),
                            returnOn10: (totalOdds * 10).toFixed(2)
                        });
                    }
                    return;
                }
                for (let i = start; i < pool.length; i++) {
                    combine(i + 1, [...combo, pool[i]]);
                }
            }
            combine(0, []);
            return results;
        }

        // --- 7. RENDERING ---

        function renderAccaCard(acca, container) {
            const card = document.createElement('div');
            card.className = 'acca-card';
            
            let legsHtml = acca.matches.map(m => {
                const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `
                <div class="leg">
                    <div class="leg-match">
                        <span class="leg-league">${m.league} â€¢ ${time}</span>
                        <span>${m.home} v ${m.away}</span>
                    </div>
                    <span class="leg-bet">${m.prediction}<br>@ ${m.selectedOdds}</span>
                </div>
            `}).join('');

            card.innerHTML = `
                <div class="acca-header">
                    <span class="acca-odds">${acca.matches.length}-Fold @ ${acca.totalOdds}</span>
                    <span class="acca-return">Returns Â£${acca.returnOn10}</span>
                </div>
                ${legsHtml}
            `;
            container.appendChild(card);
        }
    </script>
</body>
</html>
