<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acca Master: Multi-Market</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 80px; }
        h1 { color: var(--primary); margin-bottom: 5px; }
        
        .controls { margin-bottom: 20px; }
        button#scanBtn { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 1rem; cursor: pointer; }
        button:disabled { opacity: 0.5; background: #555; }
        
        .acca-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
        .acca-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: var(--primary); align-items: center;}
        
        .card-actions { display: flex; gap: 8px; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
        .action-btn { flex: 1; padding: 8px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        .btn-copy { background: #333; color: #fff; }
        .btn-open { background: #1a5c30; color: #fff; }

        .leg { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center; }
        .leg-info { display: flex; flex-direction: column; }
        .leg-meta { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
        .leg-market { color: #00ff88; font-size: 0.8rem; background: #004422; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; width: fit-content;}
        
        #console { background: #000; color: #0f0; font-family: monospace; padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 20px; height: 120px; overflow-y: scroll; border: 1px solid #333; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <h1>Acca Master Pro</h1>
    <p style="color:#888; margin-top:0;">Multi-Market ‚Ä¢ Next 48h</p>

    <div id="console">System Ready.</div>

    <div class="controls">
        <button onclick="startScan()" id="scanBtn">SEARCH ALL MARKETS</button>
    </div>

    <div id="results"></div>
    <div id="toast">Selections Copied!</div>

    <script>
        const API_KEY = '0f29a2f96e9dd4231cee515cc5ec52b0';
        const BASE_URL = 'https://v3.football.api-sports.io';
        const MIN_ACCUMULATOR_ODDS = 3.0; // Relaxed to 2/1 to ensure results
        
        // Supported Leagues: EPL, La Liga, Bundesliga, Serie A, Ligue 1, Championship, Eredivisie, Primeira Liga
        const TARGET_LEAGUES = [39, 140, 78, 135, 61, 40, 88, 94]; 

        function log(msg, type='info') {
            const c = document.getElementById('console');
            const color = type === 'error' ? '#ff5555' : (type === 'warn' ? '#ffaa00' : '#00ff88');
            c.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        async function startScan() {
            const btn = document.getElementById('scanBtn');
            const resDiv = document.getElementById('results');
            
            btn.disabled = true;
            resDiv.innerHTML = '';
            document.getElementById('console').innerHTML = ''; 
            
            log("Initializing Multi-Market Scan...");

            try {
                // 1. Get Dates
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const d1 = today.toISOString().split('T')[0];
                const d2 = tomorrow.toISOString().split('T')[0];

                log(`Scanning: ${d1} & ${d2}`);

                // 2. Fetch Data
                const [data1, data2] = await Promise.all([fetchFromApi(d1), fetchFromApi(d2)]);
                const allMatches = [...data1, ...data2];
                
                log(`Total Raw Matches: ${allMatches.length}`);

                // 3. Filter for Target Leagues
                const leagueMatches = allMatches.filter(m => TARGET_LEAGUES.includes(m.league.id));
                log(`Matches in Target Leagues: ${leagueMatches.length}`);

                if(leagueMatches.length === 0) {
                    throw new Error("No games in major leagues found.");
                }

                // 4. Debug Odds Availability
                const matchesWithOdds = leagueMatches.filter(m => m.odds && m.odds.bookmakers && m.odds.bookmakers.length > 0);
                log(`Matches with Odds Data: ${matchesWithOdds.length}`);
                
                if (matchesWithOdds.length === 0) {
                    log("WARNING: The API returned matches but NO odds.", 'warn');
                    log("This usually happens on the Free Plan.", 'warn');
                    throw new Error("API Plan Limit: Odds data missing.");
                }

                // 5. Analyze Markets
                const picks = [];
                for (const m of matchesWithOdds) {
                    const pick = findBestValueBet(m);
                    if (pick) picks.push(pick);
                }

                log(`Found ${picks.length} Value Selections.`);

                if (picks.length < 3) throw new Error("Not enough picks for an accumulator.");

                // 6. Generate Accas
                const accas = generateAccas(picks);
                log(`Generated ${accas.length} Accas.`);

                if (accas.length === 0) {
                    resDiv.innerHTML = "<p style='text-align:center'>No combinations met the odds criteria.</p>";
                } else {
                    // Show top 25
                    accas.slice(0, 25).forEach((acca, i) => renderAcca(acca, resDiv, i));
                }

            } catch (err) {
                log(err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function fetchFromApi(date) {
            // We use 'Europe/London' timezone to ensure dates align with UK time
            const response = await fetch(`${BASE_URL}/fixtures?date=${date}&timezone=Europe/London`, {
                method: "GET",
                headers: { "x-rapidapi-host": "v3.football.api-sports.io", "x-rapidapi-key": API_KEY }
            });
            const json = await response.json();
            return json.response || [];
        }

        // --- THE BRAIN: MULTI-MARKET ANALYZER ---
        function findBestValueBet(m) {
            try {
                const b = m.odds.bookmakers[0];
                if (!b) return null;

                // Helper to safely get odd value
                const getOdd = (betId, valStr) => {
                    const bet = b.bets.find(x => x.id === betId);
                    if (!bet) return null;
                    const val = bet.values.find(v => v.value.toString() === valStr);
                    return val ? parseFloat(val.odd) : null;
                };

                const candidates = [];

                // 1. MATCH WINNER (ID 1)
                const homeOdd = getOdd(1, "Home");
                const awayOdd = getOdd(1, "Away");
                
                if (homeOdd && homeOdd >= 1.4 && homeOdd <= 2.2) 
                    candidates.push({ type: "Home Win", odd: homeOdd, label: `${m.teams.home.name} to Win` });
                if (awayOdd && awayOdd >= 1.5 && awayOdd <= 2.3) 
                    candidates.push({ type: "Away Win", odd: awayOdd, label: `${m.teams.away.name} to Win` });

                // 2. OVER 2.5 GOALS (ID 5)
                const over25 = getOdd(5, "Over 2.5");
                if (over25 && over25 >= 1.5 && over25 <= 2.0)
                    candidates.push({ type: "Over 2.5 Goals", odd: over25, label: "Over 2.5 Goals" });

                // 3. BTTS (ID 8)
                const btts = getOdd(8, "Yes");
                if (btts && btts >= 1.5 && btts <= 1.95)
                    candidates.push({ type: "BTTS", odd: btts, label: "Both Teams to Score" });

                // 4. DOUBLE CHANCE (ID 12) - Good for fillers
                const dcHomeDraw = getOdd(12, "Home/Draw");
                if (dcHomeDraw && dcHomeDraw >= 1.25 && dcHomeDraw <= 1.5)
                    candidates.push({ type: "Double Chance", odd: dcHomeDraw, label: `${m.teams.home.name} or Draw` });

                // SELECTION STRATEGY: Pick the best value from this match
                // We prefer Match Winners, then Goals.
                if (candidates.length > 0) {
                    // Sort by highest odd to maximize value, or pick specific logic
                    // Here we just take the first valid one found in our priority order
                    const best = candidates[0]; 
                    
                    return {
                        home: m.teams.home.name,
                        away: m.teams.away.name,
                        league: m.league.name,
                        odd: best.odd,
                        market: best.type,
                        selection: best.label
                    };
                }

            } catch (e) {
                console.error("Error analyzing match", e);
            }
            return null;
        }

        function generateAccas(picks) {
            const results = [];
            if (picks.length < 3) return [];
            
            // Limit pool to top 20 to prevent browser freezing
            const pool = picks.slice(0, 20);
            
            function combine(start, combo, k) {
                if (combo.length === k) {
                    const total = combo.reduce((a, b) => a * b.odd, 1);
                    if (total >= MIN_ACCUMULATOR_ODDS) {
                        results.push({ matches: combo, odds: total });
                    }
                    return;
                }
                for(let i=start; i<pool.length; i++) {
                    combine(i+1, [...combo, pool[i]], k);
                }
            }
            
            // Generate 3-folds and 4-folds
            combine(0, [], 3);
            combine(0, [], 4);
            
            return results.sort((a,b) => b.odds - a.odds);
        }

        function renderAcca(acca, div, i) {
            const el = document.createElement('div');
            el.className = 'acca-card';
            
            const legs = acca.matches.map(m => `
                <div class="leg">
                    <div class="leg-info">
                        <span class="leg-meta">${m.league}</span>
                        <span>${m.home} vs ${m.away}</span>
                        <span class="leg-market">${m.selection}</span>
                    </div>
                    <strong>${m.odd.toFixed(2)}</strong>
                </div>
            `).join('');
            
            const copyText = acca.matches.map(m => `${m.home} vs ${m.away} (${m.selection})`).join(', ');

            el.innerHTML = `
                <div class="acca-header">
                    <span>${acca.matches.length}-Fold</span>
                    <span>${acca.odds.toFixed(2)} (${Math.floor(acca.odds)-1}/1)</span>
                </div>
                ${legs}
                <div class="card-actions">
                    <button class="action-btn btn-copy" onclick="copyToClipboard('${copyText}')">üìã Copy</button>
                    <button class="action-btn btn-open" onclick="window.open('https://www.bet365.com', '_blank')">‚ÜóÔ∏è Bet365</button>
                </div>
            `;
            div.appendChild(el);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const t = document.getElementById("toast");
                t.className = "show";
                setTimeout(() => t.className = t.className.replace("show", ""), 3000);
            });
        }
        
        // Service Worker Update
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').then(reg => {
                reg.onupdatefound = () => {
                    const iw = reg.installing;
                    iw.onstatechange = () => {
                        if (iw.state === 'installed' && navigator.serviceWorker.controller) {
                            window.location.reload();
                        }
                    };
                };
            });
        }
    </script>
</body>
</html>
