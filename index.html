<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acca Master: v18 Upcoming</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --safe: #4cc9f0; --risk: #f72585; --player: #ffbe0b; --card: #ff4d4d; --shot: #9d4edd; --bg: #121212; --surface: #1e1e1e; --text: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 80px; margin: 0; }
        
        .header-area { padding: 10px 0; border-bottom: 1px solid #333; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .title-group h1 { color: var(--primary); margin: 0; font-size: 1.4rem; line-height: 1.2; }
        .badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: #aaa; vertical-align: middle; }
        
        .api-monitor { text-align: right; font-family: monospace; font-size: 0.75rem; color: #666; }
        .api-val { color: var(--primary); font-weight: bold; font-size: 0.9rem; }
        
        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #1a1a1a; padding: 5px; border-radius: 12px; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 80px; background: transparent; color: #888; border: none; padding: 12px 5px; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.2s; white-space: nowrap; font-size: 0.9rem;}
        .tab-btn.active { background: #333; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Controls */
        .controls { margin-bottom: 20px; }
        button#scanBtn { background: linear-gradient(135deg, var(--primary), #00cc6a); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: 800; width: 100%; font-size: 1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(0,255,136,0.3); transition: transform 0.2s; }
        button#scanBtn:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; background: #444; cursor: wait; box-shadow: none; }
        
        /* Cards */
        .acca-card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 20px; border-left: 5px solid var(--primary); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .acca-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 12px; margin-bottom: 12px; align-items: center; }
        .acca-title { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        
        .leg { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; background: #252525; padding: 10px; border-radius: 8px; }
        .leg-info { display: flex; flex-direction: column; gap: 3px; }
        .leg-match { font-weight: 600; font-size: 0.95rem; }
        .leg-time { font-size: 0.7rem; color: #888; display: block; margin-bottom: 2px; }
        
        /* Builder Specific */
        .builder-card { border-left-color: var(--shot); }
        .builder-match { font-size: 1.2rem; margin-bottom: 10px; display: block; color: #fff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .builder-leg { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; color: #ccc; font-size: 0.9rem; }
        .check-icon { color: var(--safe); }

        /* Tags */
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 20px; font-weight: bold; width: fit-content; }
        .tag-safe { background: rgba(76, 201, 240, 0.2); color: var(--safe); }
        .tag-value { background: rgba(0, 255, 136, 0.2); color: var(--primary); }
        .tag-player { background: rgba(255, 190, 11, 0.2); color: var(--player); }
        .tag-card { background: rgba(255, 77, 77, 0.2); color: var(--card); }
        .tag-shot { background: rgba(157, 78, 221, 0.2); color: var(--shot); }

        .odds-box { background: #111; padding: 6px 10px; border-radius: 6px; font-weight: bold; color: var(--primary); min-width: 45px; text-align: center; }

        /* Console */
        #console { background: #000; color: #00ff88; font-family: monospace; padding: 15px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 20px; height: 100px; overflow-y: scroll; border: 1px solid #333; line-height: 1.5; }
        .log-warn { color: #f72585 !important; }
        .log-info { color: #4cc9f0 !important; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        .card-actions { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: background 0.2s; }
        .btn-copy { background: #333; color: #fff; }
        .btn-open { background: #1a5c30; color: #fff; }
        
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="header-area">
        <div class="title-group">
            <h1>Acca Master</h1><span class="badge">v18 Upcoming</span>
        </div>
        <div class="api-monitor">
            <span class="api-label">REMAINING CALLS</span>
            <span id="api-remaining" class="api-val">--</span>
        </div>
    </div>

    <div id="console">System Ready.<br>Waiting for scan...</div>

    <div class="controls">
        <button onclick="runMultiScan()" id="scanBtn">SEARCH TODAY'S MARKETS</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('accas')">4-Folds</button>
        <button class="tab-btn" onclick="switchTab('trebles')">Trebles</button>
        <button class="tab-btn" onclick="switchTab('upcoming')">Upcoming (Today)</button>
        <button class="tab-btn" onclick="switchTab('builders')">Bet Builders</button>
        <button class="tab-btn" onclick="switchTab('props')">Props</button>
    </div>

    <div id="accas" class="tab-content active"><div id="results-accas"></div></div>
    <div id="trebles" class="tab-content"><div id="results-trebles"></div></div>
    <div id="upcoming" class="tab-content"><div id="results-upcoming"></div></div>
    <div id="builders" class="tab-content"><div id="results-builders"></div></div>
    <div id="props" class="tab-content"><div id="results-props"></div></div>

    <div id="toast">Selections Copied!</div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = '0f29a2f96e9dd4231cee515cc5ec52b0'; 
        const BASE_URL = 'https://v3.football.api-sports.io';
        
        const MIN_ACCA_ODDS = 3.0; 
        const MIN_IND_ODDS = 1.20; 
        const CURRENT_SEASON = 2025; 
        const LEAGUES = [39, 140, 78, 135, 61, 40, 88, 94, 144, 203]; 

        // --- UTILS ---
        function log(msg, type='normal') {
            const c = document.getElementById('console');
            const color = type === 'error' ? 'log-warn' : (type === 'info' ? 'log-info' : '');
            c.innerHTML += `<div class="${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function updateApiCounter(headers) {
            if(!headers) return;
            const remaining = headers.get("x-ratelimit-requests-remaining");
            if (remaining) {
                document.getElementById('api-remaining').innerText = remaining;
                if(parseInt(remaining) < 100) document.getElementById('api-remaining').style.color = 'red';
            }
        }

        function formatTime(isoString) {
            const d = new Date(isoString);
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const day = days[d.getDay()];
            const time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            return `${day} ${time}`;
        }

        async function secureFetch(endpoint) {
            try {
                const res = await fetch(`${BASE_URL}${endpoint}`, { 
                    headers: { "x-rapidapi-key": API_KEY, "x-rapidapi-host": "v3.football.api-sports.io" } 
                });
                updateApiCounter(res.headers);
                const json = await res.json();
                if (json.errors && Object.keys(json.errors).length > 0) return null;
                return json.response;
            } catch (e) { return null; }
        }

        let teamStats = {}; 

        // --- MAIN ENGINE ---
        async function runMultiScan() {
            const btn = document.getElementById('scanBtn');
            ['accas','trebles','upcoming','builders','props'].forEach(id => document.getElementById(`results-${id}`).innerHTML = '');
            document.getElementById('console').innerHTML = ''; 
            
            btn.disabled = true;
            log("Starting Scan...", 'info');

            try {
                await buildKnowledgeBase();

                const d1 = new Date().toISOString().split('T')[0];
                const t = new Date(); t.setDate(t.getDate() + 1);
                const d2 = t.toISOString().split('T')[0];
                
                log(`Dates: ${d1} & ${d2}`);
                const [games1, games2] = await Promise.all([
                    secureFetch(`/fixtures?date=${d1}&timezone=Europe/London`), 
                    secureFetch(`/fixtures?date=${d2}&timezone=Europe/London`)
                ]);
                
                const allGames = [...(games1||[]), ...(games2||[])].filter(g => LEAGUES.includes(g.league.id));
                log(`Found ${allGames.length} valid matches.`);

                if(allGames.length === 0) throw new Error("No matches found.");

                log(`Fetching Markets...`);
                const matchesWithOdds = [];
                const oddsPromises = allGames.map(g => secureFetch(`/odds?fixture=${g.fixture.id}`));
                const oddsResults = await Promise.all(oddsPromises);
                
                for(let i=0; i<allGames.length; i++) {
                    if(oddsResults[i] && oddsResults[i][0]) {
                        allGames[i].odds = oddsResults[i][0];
                        matchesWithOdds.push(allGames[i]);
                    }
                }

                // Shuffle for variety
                matchesWithOdds.sort(() => Math.random() - 0.5);

                const picks = [];
                const builders = []; 
                const props = [];
                
                for (const m of matchesWithOdds) {
                    const matchPicks = analyzeMatch(m);
                    if (matchPicks.length > 0) picks.push(...matchPicks);
                    
                    const granularProps = analyzeGranularProps(m);
                    if (granularProps.length > 0) {
                        props.push(...granularProps);
                        if(granularProps[0].odd < 2.0) picks.push(granularProps[0]); 
                    }

                    const builder = analyzeForBuilder(m, granularProps);
                    if (builder) builders.push(builder);
                }

                log(`Pool: ${picks.length} Bets.`, 'info');

                // Generate UNIQUE Lists
                const accas4 = buildDiverseAccas(picks, 4);
                renderList(accas4.slice(0, 20), document.getElementById('results-accas'), '4-Fold');
                if(accas4.length === 0) document.getElementById('results-accas').innerHTML = "<p>No 4-folds found.</p>";

                const picksForTrebles = [...picks].sort(() => Math.random() - 0.5);
                const accas3 = buildDiverseAccas(picksForTrebles, 3);
                renderList(accas3.slice(0, 20), document.getElementById('results-trebles'), 'Treble');
                if(accas3.length === 0) document.getElementById('results-trebles').innerHTML = "<p>No Trebles found.</p>";

                // UPCOMING TAB (Today Only, Not Started)
                // Filter picks: Date matches d1 AND Status is NS
                const upcomingPicks = picks.filter(p => p.rawDate.startsWith(d1) && p.status === 'NS');
                // Sort by time
                upcomingPicks.sort((a,b) => new Date(a.rawDate) - new Date(b.rawDate));
                // We render as a list of single cards
                renderPropsList(upcomingPicks, document.getElementById('results-upcoming'));
                if(upcomingPicks.length === 0) document.getElementById('results-upcoming').innerHTML = "<p>No upcoming matches for today found.</p>";

                renderBuilders(builders.slice(0, 15), document.getElementById('results-builders'));
                if(builders.length === 0) document.getElementById('results-builders').innerHTML = "<p>No Builders found.</p>";

                renderPropsList(props.slice(0, 25), document.getElementById('results-props'));
                if(props.length === 0) document.getElementById('results-props').innerHTML = "<p>No Props found.</p>";

            } catch (err) {
                log(err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // --- LOGIC ---
        async function buildKnowledgeBase() {
            try {
                const promises = LEAGUES.map(id => secureFetch(`/standings?league=${id}&season=${CURRENT_SEASON}`));
                const results = await Promise.all(promises);
                results.forEach(res => {
                    if (!res || !res[0]) return;
                    res[0].league.standings[0].forEach(s => { 
                        teamStats[s.team.id] = { name: s.team.name, form: s.form, gf: s.all.goals.for/s.all.played, ga: s.all.goals.against/s.all.played };
                    });
                });
            } catch(e) {}
        }

        function getOdd(bets, id, val) {
            const mk = bets.find(b => b.id === id);
            if (!mk) return null;
            const v = mk.values.find(v => v.value.toString() === val);
            return v ? parseFloat(v.odd) : null;
        }

        function analyzeMatch(m) {
            if (!m.odds?.bookmakers?.[0]) return [];
            const bets = m.odds.bookmakers.find(b=>b.id===6)?.bets || m.odds.bookmakers[0].bets;
            const homeId = m.teams.home.id;
            const awayId = m.teams.away.id;
            // Removed strict dependency on stats
            const hs = teamStats[homeId] || { form: "?????" }; 
            const as = teamStats[awayId] || { form: "?????" }; 

            const validBets = [];
            const matchName = `${m.teams.home.name} v ${m.teams.away.name}`;
            const timeStr = formatTime(m.fixture.date);
            const rawDate = m.fixture.date;
            const status = m.fixture.status.short;

            // 1. Winner
            const homeWin = getOdd(bets, 1, "Home");
            if (homeWin >= MIN_IND_ODDS && homeWin <= 2.2) {
                if (hs.form === "?????" || (hs.form.match(/L/g)||[]).length <= 2) {
                    validBets.push({match: matchName, rawDate, status, time: timeStr, leagueId: m.league.id, matchId: m.fixture.id, sel: `${m.teams.home.name} Win`, odd: homeWin, type: 'Banker'});
                }
            }
            const awayWin = getOdd(bets, 1, "Away");
            if (awayWin >= MIN_IND_ODDS && awayWin <= 2.2) {
                if (as.form === "?????" || (as.form.match(/L/g)||[]).length <= 2) {
                    validBets.push({match: matchName, rawDate, status, time: timeStr, leagueId: m.league.id, matchId: m.fixture.id, sel: `${m.teams.away.name} Win`, odd: awayWin, type: 'Banker'});
                }
            }
            
            // 2. Goals
            const over25 = getOdd(bets, 5, "Over 2.5");
            if (over25 && over25 >= 1.35 && over25 <= 1.9) {
                 validBets.push({match: matchName, rawDate, status, time: timeStr, leagueId: m.league.id, matchId: m.fixture.id, sel: "Over 2.5 Goals", odd: over25, type: 'Value'});
            }

            // 3. Double Chance
            const dcHome = getOdd(bets, 12, "Home/Draw");
            if(dcHome && dcHome >= 1.25 && dcHome <= 1.5) {
                 validBets.push({match: matchName, rawDate, status, time: timeStr, leagueId: m.league.id, matchId: m.fixture.id, sel: `${m.teams.home.name} (DC)`, odd: dcHome, type: 'Safe'});
            }

            return validBets;
        }

        function analyzeGranularProps(m) {
            if (!m.odds?.bookmakers?.[0]) return [];
            const bets = m.odds.bookmakers.find(b=>b.id===6)?.bets || m.odds.bookmakers[0].bets;
            const props = [];
            const matchName = `${m.teams.home.name} v ${m.teams.away.name}`;
            const timeStr = formatTime(m.fixture.date);
            const rawDate = m.fixture.date;
            const status = m.fixture.status.short;

            // Card
            const cardMarket = bets.find(b => b.name.includes("Card") || b.name.includes("Booking"));
            if (cardMarket) {
                const candidates = cardMarket.values.filter(v => parseFloat(v.odd) >= 2.0 && parseFloat(v.odd) <= 4.0);
                if (candidates.length > 0) {
                    candidates.sort((a,b) => parseFloat(a.odd) - parseFloat(b.odd));
                    props.push({ match: matchName, rawDate, status, time: timeStr, leagueId: m.league.id, matchId: m.fixture.id, sel: `${candidates[0].value} Card`, odd: parseFloat(candidates[0].odd), type: 'Card' });
                }
            }
            // Shot
            const shotMarket = bets.find(b => b.name.includes("Shots on Target"));
            if (shotMarket) {
                 const candidates = shotMarket.values.filter(v => parseFloat(v.odd) >= 1.5 && parseFloat(v.odd) <= 2.5 && v.value.includes("Over"));
                 if (candidates.length > 0) {
                    candidates.sort((a,b) => parseFloat(a.odd) - parseFloat(b.odd));
                    props.push({ match: matchName, rawDate, status, time: timeStr, leagueId: m.league.id, matchId: m.fixture.id, sel: `${candidates[0].value} SoT`, odd: parseFloat(candidates[0].odd), type: 'Shot' });
                }
            }
            // Scorer
             const scorerMarket = bets.find(b => b.name === "Anytime Goalscorer");
             if (scorerMarket) {
                 const candidates = scorerMarket.values.filter(v => parseFloat(v.odd) >= 1.6 && parseFloat(v.odd) <= 2.8);
                 if(candidates.length > 0) {
                     candidates.sort((a,b) => parseFloat(a.odd) - parseFloat(b.odd));
                     props.push({ match: matchName, rawDate, status, time: timeStr, leagueId: m.league.id, matchId: m.fixture.id, sel: `${candidates[0].value} Score`, odd: parseFloat(candidates[0].odd), type: 'Player' });
                 }
             }
            return props;
        }

        function analyzeForBuilder(m, props) {
            if (!m.odds?.bookmakers?.[0]) return null;
            const bets = m.odds.bookmakers.find(b=>b.id===6)?.bets || m.odds.bookmakers[0].bets;
            const homeWin = getOdd(bets, 1, "Home");
            const legs = [];
            const timeStr = formatTime(m.fixture.date);

            if (homeWin && homeWin < 2.0) legs.push(`Match Result: ${m.teams.home.name}`);

            if (props && props.length > 0) {
                legs.push(props[0].sel);
            } else {
                const over25 = getOdd(bets, 5, "Over 2.5");
                if (over25 && over25 < 1.8) legs.push("Over 2.5 Goals");
            }

            if (legs.length >= 2) return { match: `${m.teams.home.name} v ${m.teams.away.name}`, time: timeStr, legs: legs };
            return null;
        }

        function buildDiverseAccas(pool, size) {
            const results = [];
            let available = [...pool]; 

            while(available.length >= size) {
                const currentAcca = [];
                const usedMatchIds = new Set();
                const usedLeagueIds = {}; 
                const indicesToRemove = [];

                for(let i=0; i<available.length; i++) {
                    const bet = available[i];
                    if (usedMatchIds.has(bet.matchId)) continue;
                    const lCount = usedLeagueIds[bet.leagueId] || 0;
                    if (lCount >= 2) continue;

                    currentAcca.push(bet);
                    usedMatchIds.add(bet.matchId);
                    usedLeagueIds[bet.leagueId] = lCount + 1;
                    indicesToRemove.push(i);

                    if (currentAcca.length === size) break;
                }

                if (currentAcca.length < size) break;

                const total = currentAcca.reduce((a, b) => a * b.odd, 1);
                
                if (total >= MIN_ACCA_ODDS) {
                    results.push({ matches: currentAcca, odds: total });
                    for (let i = indicesToRemove.length - 1; i >= 0; i--) {
                        available.splice(indicesToRemove[i], 1);
                    }
                } else {
                    available.splice(0, 1);
                }
                
                if (results.length >= 30) break;
            }
            return results;
        }

        // --- RENDER ---
        function renderList(list, div, label) {
            list.forEach(acca => {
                const el = document.createElement('div');
                el.className = 'acca-card';
                const legs = acca.matches.map(m => {
                    let tagClass = 'tag-value';
                    if(m.type === 'Card') tagClass = 'tag-card';
                    if(m.type === 'Shot') tagClass = 'tag-shot';
                    if(m.type === 'Player') tagClass = 'tag-player';
                    return `
                    <div class="leg">
                        <div class="leg-info">
                            <span class="leg-time">${m.time}</span>
                            <span class="leg-match">${m.match}</span>
                            <div style="display:flex;align-items:center;"><span class="tag ${tagClass}">${m.sel}</span></div>
                        </div>
                        <div class="odds-box">${m.odd.toFixed(2)}</div>
                    </div>`;
                }).join('');
                const copyText = acca.matches.map(m => `${m.match} - ${m.sel}`).join(', ');
                el.innerHTML = `<div class="acca-header"><div class="acca-title">${label}</div><div style="font-size:1.4rem;font-weight:800;color:#fff;">${acca.odds.toFixed(2)}</div></div>${legs}<div class="card-actions"><button class="action-btn btn-copy" onclick="copyToClipboard('${copyText}')">üìã Copy</button><button class="action-btn btn-open" onclick="window.open('https://www.bet365.com', '_blank')">‚ÜóÔ∏è Bet365</button></div>`;
                div.appendChild(el);
            });
        }
        function renderPropsList(list, div) {
             list.forEach(p => {
                const el = document.createElement('div');
                el.className = 'acca-card';
                let tagClass = 'tag-value';
                if(p.type === 'Card') tagClass = 'tag-card';
                if(p.type === 'Shot') tagClass = 'tag-shot';
                if(p.type === 'Player') tagClass = 'tag-player';
                el.innerHTML = `<div class="acca-header"><div class="acca-title">${p.match}</div></div><div class="leg"><div class="leg-info"><span class="leg-time">${p.time}</span><span class="tag ${tagClass}">${p.sel}</span></div><div class="odds-box">${p.odd.toFixed(2)}</div></div><div class="card-actions"><button class="action-btn btn-copy" onclick="copyToClipboard('${p.sel}')">üìã Copy</button></div>`;
                div.appendChild(el);
            });
        }
        function renderBuilders(list, div) {
            list.forEach(b => {
                const el = document.createElement('div');
                el.className = 'acca-card builder-card';
                const legs = b.legs.map(l => `<div class="builder-leg"><span class="check-icon">‚úî</span> ${l}</div>`).join('');
                const copyText = `${b.match} Bet Builder: ${b.legs.join(', ')}`;
                el.innerHTML = `<span class="builder-match">${b.match} <small style="font-size:0.7rem; color:#888;">${b.time}</small></span>${legs}<div class="card-actions"><button class="action-btn btn-copy" onclick="copyToClipboard('${copyText}')">üìã Copy</button><button class="action-btn btn-open" onclick="window.open('https://www.bet365.com', '_blank')">‚ÜóÔ∏è Bet365</button></div>`;
                div.appendChild(el);
            });
        }
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const t = document.getElementById("toast");
                t.className = "show";
                setTimeout(() => t.className = t.className.replace("show", ""), 3000);
            });
        }
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').then(reg => {
                reg.onupdatefound = () => {
                    const iw = reg.installing;
                    iw.onstatechange = () => { if (iw.state === 'installed' && navigator.serviceWorker.controller) window.location.reload(); };
                };
            });
        }
    </script>
</body>
</html>
